<html>
<script src="bitcoinjs-min.js"></script>
<script src="//brainwallet.github.io/js/bitcoinsig.js"></script>
<script>
// Bitcoin Key
var secret = '5JtXKC1YnkRbFFkJ7U5dJE7pCzmgZsE8GN6YK1Kn6e3VaccVw2H';

// Sets up API Websocket
var attempts = 1, timer = 0;
connectAPI();

function connectAPI () {
  api = new WebSocket('wss://api.cryptocapital.co');

  api.onopen = function () {
    console.log('Connected to wss://api.cryptocapital.co');
    attempts = 1;
  };
  
  api.onmessage = function (msg) {
    parseAPI(msg);
  };

  api.onclose = function () {
    console.log('Disconnected from wss://api.cryptocapital.co');
    var time = generateInterval(attempts);
    setTimeout(function () { attempts++; connectAPI(); }, time);
  };
}

function generateInterval (k) {
  var maxInterval = (Math.pow(2, k) - 1) * 1000;
  if (maxInterval > 30*1000) { maxInterval = 30*1000; }
  return Math.random() * maxInterval;
}

function parseAPI(msg) {
  var data = JSON.parse(msg.data);
  
  // Success Messages
  if (data.msg == 'success') {
    console.log(JSON.stringify(data));
  }

  // Failure Messages
  if (data.msg == 'error') {
    console.log(JSON.stringify(data));
  }

  // Authentication Challenge 
  if (data.msg == 'challenge') {
    console.log(JSON.stringify(data));
    var msg = data.data;
    var key = bitcoin.ECKey.fromWIF(secret);
    var pub = key.pub.getAddress().toString();
    var sig = bitcoin.Message.sign(key, msg).toString('base64');
    api.send(JSON.stringify({'op':'auth','params':{'key':pub,'signature':sig}}));
  }

  // Authentication Success
  if (data.msg == 'auth') {
    console.log(JSON.stringify(data));

    var op = {'op':'transfer','params':{'destination':'1PvxrqrcBsbsyE4Yczow6jh55hUZYH4Qkq','currency':'USD','amount':'1000.00'}};
    //api.send(JSON.stringify(op));
  }

  // Transfer Notifications
  if (data.msg == 'transfer') {
    console.log(JSON.stringify(data));
  }
}
</script>
</head>
<body>
</body>
</html>
